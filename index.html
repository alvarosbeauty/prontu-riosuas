<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Prontuário SUAS – CRAS Arara/PB</title>
  <style>
    :root{
      --bg:#e3e2de; --primary:#985d3b; --soft1:#f9d0b4; --soft2:#dcb18c;
      --textDark:#2A1E18; --textLight:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--textDark);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--primary)} button{cursor:pointer}
    .container{max-width:1200px;margin:0 auto;padding:0 16px}
    /* Header */
    header{
      position:relative;overflow:hidden;color:#fff
    }
    header .grad{position:absolute;inset:0;
      background:linear-gradient(90deg,var(--soft1) 0%,var(--soft2) 50%,var(--primary) 100%);
    }
    header .wrap{position:relative;padding:24px 0}
    .row{display:grid;grid-template-columns:1fr;gap:16px;align-items:center}
    @media(min-width:900px){.row{grid-template-columns:1.1fr 0.8fr 1.1fr}}
    .logoBox{width:64px;height:64px;border-radius:16px;border:1px solid #ffffff55;background:#ffffff1a;
      display:flex;align-items:center;justify-content:center;overflow:hidden;margin-right:12px}
    .flex{display:flex;align-items:center}
    h1{margin:0 0 4px;font-size:26px;line-height:1.2}
    .muted{opacity:.9}
    /* Buttons */
    .btn{padding:8px 12px;border-radius:12px;border:1px solid #0000001a;background:transparent}
    .btn.solid{background:var(--primary);color:#fff;border-color:transparent}
    .btn + .btn{margin-left:8px}
    .chip{display:inline-block;padding:2px 8px;border:1px solid #0000001a;border-radius:999px;background:#ffffffb3;font-size:12px;margin:2px 6px 0 0}
    /* Layout */
    main{padding:24px 0}
    .grid{display:grid;gap:16px}
    @media(min-width:1200px){.grid{grid-template-columns:1fr 1fr 1fr 1fr 1fr}}
    .card{background:#fff;border:1px solid #00000012;border-radius:18px;padding:16px;box-shadow:0 1px 2px #0000000d}
    .card h3{margin:0 0 12px;font-size:18px}
    .field{margin-bottom:10px}
    .label{display:block;font-weight:600;font-size:13px;margin-bottom:4px;opacity:.9}
    .input,.textarea{width:100%;border:1px solid #0000001a;border-radius:12px;padding:8px 10px}
    .textarea{min-height:84px;resize:vertical}
    .list{max-height:60vh;overflow:auto;border-top:1px solid #0000000f}
    .list .item{display:flex;justify-content:space-between;align-items:flex-start;padding:10px 0;border-bottom:1px solid #0000000f}
    .danger{color:#b42318}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid #0000001a;border-radius:12px;padding:8px 12px;background:#fff}
    .tab.active{background:var(--primary);color:#fff;border-color:transparent}
    .alert{background:#fef3c7;border:1px solid #fde68a;color:#92400e;border-radius:12px;padding:10px;margin-bottom:10px}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.kv{grid-template-columns:1fr}}
    .right{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    .small{font-size:12px;color:#0000008a}
    .nowrap{white-space:nowrap}
    .hidden{display:none}
    .links{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    @media print { header, .no-print { display:none !important; } main { padding:0 !important; } .print-page-break { page-break-after: always; } }
  </style>
</head>
<body>
  <header>
    <div class="grad"></div>
    <div class="container wrap">
      <div class="row">
        <div class="flex">
          <div class="logoBox"><img id="logo" alt="Logo" style="max-width:100%;max-height:100%"></div>
          <div>
            <h1>Prontuário SUAS</h1>
            <div class="muted">CRAS Arara/PB · Registro e acompanhamento familiar</div>
          </div>
        </div>
        <div class="muted" style="text-align:center">
          <div class="small">Responsável técnico</div>
          <div style="font-weight:700">Walisom Álvaro</div>
          <div>Psicólogo · CRP 13/12242</div>
          <div class="small">Doutor em TCC · Especialista em Psicologia Social</div>
        </div>
        <div class="right">
          <label class="btn"><span class="nowrap">Importar JSON</span>
            <input id="importJson" type="file" accept="application/json" class="hidden">
          </label>
          <button id="exportCsv" class="btn solid">Exportar CSV</button>
          <button id="exportJson" class="btn">Exportar JSON</button>
          <button id="printBtn" class="btn solid">Imprimir</button>
          <button id="cfgBtn" class="btn">Configurações</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <!-- Lista -->
      <section class="card" style="grid-column: span 2">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h3>Famílias / Usuários</h3>
          <button id="newFamily" class="btn solid">+ Nova família</button>
        </div>
        <div class="field">
          <input id="search" class="input" placeholder="Buscar por nome">
        </div>
        <div id="familyList" class="list"></div>
      </section>

      <!-- Detalhes -->
      <section class="card" style="grid-column: span 2">
        <h3>Detalhes do prontuário</h3>
        <div id="detailsEmpty" class="small">Selecione uma família na lista ou crie um novo prontuário.</div>
        <div id="details" class="hidden">
          <div class="tabs" id="tabs">
            <button data-tab="cadastro" class="tab active">Cadastro</button>
            <button data-tab="timeline" class="tab">Linha do tempo</button>
            <button data-tab="visitas" class="tab">Visitas</button>
            <button data-tab="resumo" class="tab">Resumo</button>
            <button data-tab="regras" class="tab">Recomendações</button>
          </div>

          <div id="lgpd" class="alert hidden"></div>

          <div id="tab-cadastro">
            <div class="kv">
              <div class="field"><label class="label">Nome de referência</label><input id="f_nome" class="input"></div>
              <div class="field"><label class="label">Nº do prontuário</label><input id="f_prontuario" class="input"></div>
              <div class="field"><label class="label">NIS do responsável</label><input id="f_nis" class="input"></div>
              <div class="field"><label class="label">Telefone</label><input id="f_tel" class="input"></div>
              <div class="field"><label class="label">Endereço</label><input id="f_end" class="input"></div>
              <div class="field"><label class="label">Bairro</label><input id="f_bairro" class="input"></div>
              <div class="field"><label class="label">Município</label><input id="f_mun" class="input" value="Arara/PB"></div>
              <div class="field"><label class="label">Renda familiar (R$)</label><input id="f_renda" class="input"></div>
              <div class="field" style="grid-column:1/-1"><label class="label">Demandas (separe por vírgula)</label><textarea id="f_demandas" class="textarea" placeholder="ex.: insegurança alimentar, violência doméstica, deficiência, desemprego…"></textarea></div>
              <div class="field" style="grid-column:1/-1"><label class="label">Resumo do caso (sintético)</label><textarea id="f_resumo" class="textarea"></textarea></div>
            </div>

            <div style="margin-top:8px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div class="label">Composição familiar</div>
                <button id="addMember" class="btn solid">+ Adicionar membro</button>
              </div>
              <div id="members"></div>
            </div>
          </div>

          <div id="tab-timeline" class="hidden">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div class="label">Linha do tempo</div>
              <button id="addTimeline" class="btn solid">+ Registrar evento</button>
            </div>
            <div id="timeline"></div>
          </div>

          <div id="tab-visitas" class="hidden">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div class="label">Visitas domiciliares / atendimentos</div>
              <button id="addVisita" class="btn solid">+ Nova visita</button>
            </div>
            <div id="visitas"></div>
          </div>

          <div id="tab-resumo" class="hidden">
            <div class="card" style="padding:12px">
              <div class="label">Resumo do caso</div>
              <div id="resumoOut" class="small"></div>
            </div>
            <div class="card" style="padding:12px;margin-top:10px">
              <div class="label">Demandas indicadas</div>
              <div id="demandasOut"></div>
            </div>
            <div class="small" id="audit"></div>
          </div>

          <div id="tab-regras" class="hidden">
            <div id="regrasList"></div>
          </div>
        </div>
      </section>

      <!-- Referências -->
      <aside class="card" style="grid-column: span 1">
        <h3>Base normativa & referências</h3>
        <div id="refs"></div>
      </aside>
    </div>
  </main>

  <!-- Modal Configurações -->
  <dialog id="cfgModal">
    <form method="dialog" class="card" style="min-width: 320px">
      <h3>Configurações</h3>
      <div class="field">
        <div class="label">Logo (Base64)</div>
        <div class="flex">
          <img id="cfgLogoPreview" style="width:48px;height:48px;border-radius:10px;border:1px solid #0000001a;object-fit:contain;margin-right:8px">
          <label class="btn solid">Carregar imagem
            <input id="cfgLogoInput" type="file" accept="image/*" class="hidden">
          </label>
          <button id="cfgLogoReset" type="button" class="btn" style="margin-left:8px">Restaurar padrão</button>
        </div>
        <div class="small" style="margin-top:6px">A imagem é convertida para Base64 e salva localmente (localStorage).</div>
      </div>
      <div style="text-align:right">
        <button class="btn">Fechar</button>
      </div>
    </form>
  </dialog>

<script>
// ======= Persistência =======
const DB_KEY = "cras_prontuario_db";
const LOGO_KEY = "cras_logo_b64";
const PLACEHOLDER_LOGO = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABhQJ2YQAAAABJRU5ErkJggg==";

function loadDB(){ try{return JSON.parse(localStorage.getItem(DB_KEY)||"{}");}catch{return{};} }
function saveDB(data){ localStorage.setItem(DB_KEY, JSON.stringify(data)); }
function loadLogo(){ return localStorage.getItem(LOGO_KEY) || PLACEHOLDER_LOGO; }
function saveLogo(b64){ localStorage.setItem(LOGO_KEY, b64); }

// ======= Modelos =======
function emptyFamily(){
  return {
    id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()),
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    nomeReferencia:"", nisReferencia:"", prontuarioN:"",
    telefone:"", endereco:"", bairro:"", municipio:"Arara/PB",
    membros:[], rendaFamiliar:"", demandas:"", resumoCaso:"",
    timeline:[], visitas:[]
  };
}

// ======= Base normativa =======
const NORMATIVE_KB = [
  { id:"loas-bpc", title:"LOAS / BPC (Lei 8.742/1993)", keywords:["bpc","benefício de prestação continuada","deficiência","idoso","renda","1/4 salário","vulnerabilidade"],
    summary:"Verificar elegibilidade ao BPC para idoso (≥65) ou pessoa com deficiência; avaliação social/médica; visita domiciliar; CadÚnico.",
    sources:[
      {label:"Lei 8.742/1993 (LOAS)", url:"https://www.planalto.gov.br/ccivil_03/leis/l8742.htm"},
      {label:"MDS – BPC", url:"https://www.gov.br/mds/pt-br/assuntos/assistencia-social/beneficios-assistenciais/bpc"}
    ]},
  { id:"pnas", title:"PNAS / Proteção Social Básica", keywords:["paif","psb","scfv","vínculos","acompanhamento familiar","território","pnas"],
    summary:"Inserção no PAIF/SCFV; plano de acompanhamento familiar; metas e periodicidade; registro em prontuário SUAS.",
    sources:[
      {label:"Res. CNAS 145/2004 (PNAS)", url:"https://www.mds.gov.br/webarquivos/publicacao/assistencia_social/Normativas/PNAS2004.pdf"},
      {label:"Res. CNAS 109/2009 (Tipificação)", url:"https://www.mds.gov.br/webarquivos/publicacao/assistencia_social/Normativas/Tipificacao.pdf"}
    ]},
  { id:"eca", title:"ECA – Estatuto da Criança e do Adolescente", keywords:["violência","negligência","abandono","trabalho infantil","direitos","medidas de proteção","conselho tutelar"],
    summary:"Acionar rede (Conselho Tutelar, escola, saúde); preservar sigilo e melhor interesse da criança/adolescente.",
    sources:[{label:"Lei 8.069/1990", url:"https://www.planalto.gov.br/ccivil_03/leis/l8069.htm"}]},
  { id:"idoso", title:"Estatuto da Pessoa Idosa", keywords:["idoso","abandono","violência financeira","prioridade","acolhimento","cuidador"],
    summary:"Prioridade de atendimento; avaliar riscos; articular com saúde e rede de proteção; registrar encaminhamentos.",
    sources:[{label:"Lei 10.741/2003", url:"https://www.planalto.gov.br/ccivil_03/leis/2003/l10.741.htm"}]},
  { id:"lbi", title:"LBI – Estatuto da Pessoa com Deficiência", keywords:["deficiência","acessibilidade","barreiras","inclusão","benefício","direitos"],
    summary:"Mapear barreiras; orientar sobre acessibilidade/benefícios; articular com saúde/educação.",
    sources:[{label:"Lei 13.146/2015", url:"https://www.planalto.gov.br/ccivil_03/_ato2015-2018/2015/lei/l13146.htm"}]},
  { id:"violencia-mulher", title:"Lei Maria da Penha e Rede de Enfrentamento", keywords:["violência doméstica","ameaça","agressão","medida protetiva","mulher"],
    summary:"Medidas protetivas; articular CREAS/DEAM; acolhimento sem revitimização; registro cuidadoso.",
    sources:[{label:"Lei 11.340/2006", url:"http://www.planalto.gov.br/ccivil_03/_ato2004-2006/2006/lei/l11340.htm"}]},
  { id:"cfp", title:"Ética Profissional – CFP", keywords:["sigilo","consentimento","prontuário","ética","laudo","parecer"],
    summary:"Sigilo, consentimento informado, minimização de dados e guarda segura; relativização em risco iminente conforme legislação.",
    sources:[{label:"Código de Ética – CFP", url:"https://site.cfp.org.br/servicos/legislacao/codigo-de-etica-profissional-do-psicologo/"}]},
];

const SENSITIVE_PATTERNS = [
  { id:"cpf", label:"CPF", regex:/\b\d{3}\.?\d{3}\.?\d{3}-?\d{2}\b/g },
  { id:"rg", label:"RG", regex:/\brg\b\s*[:º-]?\s*\d+/gi },
  { id:"telefone", label:"Telefone", regex:/(\+?55\s?)?\(?\d{2}\)?\s?\d{4,5}-?\d{4}/g },
  { id:"saude", label:"Dados de saúde", regex:/(diagnóstico|cid-?10|cid-?11|transtorno|hiv|aids|gestante|doença)/gi },
  { id:"endereco", label:"Endereço completo", regex:/(rua|avenida|travessa|sítio|bairro|lote|quadra)/gi },
  { id:"bancario", label:"Dados bancários", regex:/(agência|conta|pix|banco|chave pix)/gi },
];

// ======= Estado =======
let db = { familias: loadDB().familias || [] };
let selectedId = null;
let activeTab = "cadastro";

// ======= Util =======
function qs(s, el=document){ return el.querySelector(s); }
function qsa(s, el=document){ return [...el.querySelectorAll(s)]; }
function setHidden(el, hidden){ el.classList.toggle("hidden", !!hidden); }
function download(filename, text, mime="text/plain;charset=utf-8"){
  const blob = new Blob([text], {type:mime});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}
function toCSV(records){
  const header = ["id","nomeReferencia","prontuarioN","nisReferencia","telefone","endereco","bairro","municipio","rendaFamiliar","demandas","resumoCaso","createdAt","updatedAt"];
  const rows = [header.join(",")];
  records.forEach(r => rows.push(header.map(h => JSON.stringify((r[h]??"").toString()).replace(/\n/g," ")).join(",")));
  return rows.join("\n");
}

// ======= Render =======
function render(){
  // Logo
  const logo = loadLogo();
  qs("#logo").src = logo;

  // Referências
  const refs = qs("#refs");
  refs.innerHTML = "";
  NORMATIVE_KB.forEach(n => {
    const div = document.createElement("div");
    div.style.marginBottom="10px";
    div.innerHTML = `<div style="font-weight:700">${n.title}</div>
      <div class="small">Palavras‑chave: ${n.keywords.join(", ")}</div>
      <div class="links">${n.sources.map(s=>`<a href="${s.url}" target="_blank" rel="noreferrer">${s.label}</a>`).join("")}</div>`;
    refs.appendChild(div);
  });

  // Lista famílias
  const list = qs("#familyList");
  const q = qs("#search").value.trim().toLowerCase();
  const data = q ? db.familias.filter(f => (f.nomeReferencia||"").toLowerCase().includes(q)) : db.familias;
  list.innerHTML = "";
  data.forEach(f => {
    const li = document.createElement("div");
    li.className="item";
    li.innerHTML = `<div>
      <div style="font-weight:600">${f.nomeReferencia||"<em class='small' style='color:#0000008a'>(sem nome)</em>"}</div>
      <div class="small">Pront. ${f.prontuarioN||"—"} · NIS ${f.nisReferencia||"—"}</div>
      <div>${(f.demandas||"").split(/[,;]+/).slice(0,3).filter(Boolean).map(d=>`<span class="chip">${d.trim()}</span>`).join("")}</div>
    </div>
    <div>
      <button class="btn danger" data-del="${f.id}">Excluir</button>
    </div>`;
    li.addEventListener("click", (e)=>{
      if(e.target.closest("[data-del]")) return; // handled below
      selectedId = f.id;
      openDetails();
    });
    li.querySelector("[data-del]").addEventListener("click", (e)=>{
      e.stopPropagation();
      if(confirm("Remover este prontuário?")){
        db.familias = db.familias.filter(x=>x.id!==f.id);
        if(selectedId===f.id) selectedId=null;
        saveDB(db); render();
      }
    });
    list.appendChild(li);
  });

  // Detalhes
  if(!selectedId){
    setHidden(qs("#detailsEmpty"), false);
    setHidden(qs("#details"), true);
    return;
  }
  setHidden(qs("#detailsEmpty"), true);
  setHidden(qs("#details"), false);

  qsa(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===activeTab));
  qsa('[id^="tab-"]').forEach(el=>setHidden(el, true));
  setHidden(qs("#tab-"+activeTab), false);

  const f = db.familias.find(x=>x.id===selectedId);
  // vincular campos
  bindInput("f_nome","nomeReferencia");
  bindInput("f_prontuario","prontuarioN");
  bindInput("f_nis","nisReferencia");
  bindInput("f_tel","telefone");
  bindInput("f_end","endereco");
  bindInput("f_bairro","bairro");
  bindInput("f_mun","municipio");
  bindInput("f_renda","rendaFamiliar");
  bindInput("f_demandas","demandas", true);
  bindInput("f_resumo","resumoCaso", true);

  function bindInput(id, key, isText){
    const el = qs("#"+id);
    if(document.activeElement!==el) el.value = f[key]||"";
    el.oninput = () => { f[key] = el.value; touch(); };
  }

  // membros
  const mem = qs("#members"); mem.innerHTML="";
  if(!f.membros.length) mem.innerHTML = `<div class="small">Sem membros cadastrados.</div>`;
  f.membros.forEach(m=>{
    const wrap = document.createElement("div");
    wrap.className="kv card"; wrap.style.padding="12px"; wrap.style.marginBottom="8px";
    wrap.innerHTML = `
      <div class="field"><label class="label">Nome</label><input class="input" value="${m.nome||""}" data-k="nome"></div>
      <div class="field"><label class="label">Parentesco</label><input class="input" value="${m.parentesco||""}" data-k="parentesco"></div>
      <div class="field"><label class="label">Idade</label><input class="input" value="${m.idade||""}" data-k="idade"></div>
      <div class="field"><label class="label">NIS</label><input class="input" value="${m.nis||""}" data-k="nis"></div>
      <div class="field"><label class="label">Escolaridade</label><input class="input" value="${m.escolaridade||""}" data-k="escolaridade"></div>
      <div class="field"><label class="label">Renda (R$)</label>
        <div class="flex">
          <input class="input" style="flex:1" value="${m.renda||""}" data-k="renda">
          <button class="btn danger" style="margin-left:8px" data-remove>Remover</button>
        </div>
      </div>`;
    wrap.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("input", ()=>{ m[inp.dataset.k]=inp.value; touch(); });
    });
    wrap.querySelector("[data-remove]").addEventListener("click", ()=>{
      f.membros = f.membros.filter(x=>x!==m); touch(); render();
    });
    mem.appendChild(wrap);
  });

  // timeline
  const tl = qs("#timeline"); tl.innerHTML="";
  if(!f.timeline.length) tl.innerHTML = `<div class="small">Sem registros na linha do tempo.</div>`;
  f.timeline.forEach(t=>{
    const li = document.createElement("div");
    li.className="card"; li.style.padding="12px"; li.style.marginBottom="8px";
    li.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:600">${t.titulo||"Registro"}</div>
        <div class="small">${new Date(t.dataISO).toLocaleString()}</div>
      </div>
      <div class="small">${t.tipo||"Acompanhamento"}</div>
      <div class="field"><label class="label">Descrição</label><textarea class="textarea" data-k="descricao">${t.descricao||""}</textarea></div>`;
    li.querySelector("[data-k]").addEventListener("input", (e)=>{ t.descricao = e.target.value; touch(); });
    tl.appendChild(li);
  });

  // visitas
  const vv = qs("#visitas"); vv.innerHTML="";
  if(!f.visitas.length) vv.innerHTML = `<div class="small">Sem visitas registradas.</div>`;
  f.visitas.forEach(v=>{
    const li = document.createElement("div");
    li.className="card"; li.style.padding="12px"; li.style.marginBottom="8px";
    li.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small" style="font-weight:600">${new Date(v.dataISO).toLocaleString()}</div>
      </div>
      <div class="field"><label class="label">Objetivo</label><input class="input" data-k="objetivo" value="${v.objetivo||""}"></div>
      <div class="field"><label class="label">Observações (evitar dados excessivamente sensíveis)</label><textarea class="textarea" data-k="observacoes">${v.observacoes||""}</textarea></div>`;
    li.querySelectorAll("[data-k]").forEach(el=>{
      el.addEventListener("input", ()=>{ v[el.dataset.k]=el.value; touch(); });
    });
    vv.appendChild(li);
  });

  // resumo
  qs("#resumoOut").textContent = f.resumoCaso || "(sem resumo)";
  qs("#demandasOut").innerHTML = (f.demandas||"").split(/[,;]+/).filter(Boolean).map(d=>`<span class="chip">${d.trim()}</span>`).join("");
  qs("#audit").textContent = "Criado em "+new Date(f.createdAt).toLocaleString()+" · Atualizado em "+new Date(f.updatedAt).toLocaleString();

  // recomendações
  const text = `${f.demandas} ${f.resumoCaso} ${f.visitas.map(v=>`${v.objetivo} ${v.observacoes}`).join(" ")}`.toLowerCase();
  const recs = NORMATIVE_KB.filter(n => n.keywords.some(k => text.includes(k.toLowerCase())));
  const regras = qs("#regrasList"); regras.innerHTML="";
  if(!recs.length){ regras.innerHTML = `<div class="small">Sem recomendações automáticas no momento. Preencha “Demandas”, “Resumo” e “Visitas”.</div>`; }
  recs.forEach(r=>{
    const li = document.createElement("div");
    li.className="card"; li.style.padding="12px"; li.style.marginBottom="8px";
    li.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">${r.title}</div>
        <div class="small">Detectado por palavras‑chave</div>
      </div>
      <div class="small" style="margin-top:6px">${r.summary}</div>
      <div class="links" style="margin-top:6px">${r.sources.map(s=>`<a target="_blank" rel="noreferrer" href="${s.url}">Fontes: ${s.label}</a>`).join("")}</div>
      <div class="small" style="margin-top:6px">*Recomendações de apoio. A análise técnica segue o PAIF, o Código de Ética/CFP e a legislação vigente.</div>`;
    regras.appendChild(li);
  });

  // LGPD alerta
  const lg = qs("#lgpd");
  const blob = [f.resumoCaso, f.demandas, f.visitas.map(v=>v.observacoes).join(" ")].join(" ");
  const finds = [];
  SENSITIVE_PATTERNS.forEach(p => {
    const m = blob.match(p.regex);
    if(m && m.length) finds.push(p.label+": "+m.length);
  });
  if(finds.length){
    lg.innerHTML = `<div style="font-weight:700">Alerta de LGPD/Ética</div>
      <div class="small">Foram detectados dados sensíveis. Revise a necessidade, obtenha consentimento e minimize a exposição.</div>
      <div style="margin-top:6px">${finds.map(x=>`<span class="chip">${x}</span>`).join("")}</div>`;
    setHidden(lg, false);
  } else {
    setHidden(lg, true);
  }
}

function touch(){ // atualizar updatedAt, salvar e refletir
  const f = db.familias.find(x=>x.id===selectedId);
  if(f){ f.updatedAt = new Date().toISOString(); }
  saveDB(db);
}

// ======= Ações =======
qs("#newFamily").addEventListener("click", ()=>{
  const fam = emptyFamily();
  db.familias.unshift(fam);
  selectedId = fam.id;
  saveDB(db); render(); openDetails();
});

qs("#search").addEventListener("input", render);

qsa(".tab").forEach(btn => btn.addEventListener("click", ()=>{
  activeTab = btn.dataset.tab; render();
}));

qs("#addMember").addEventListener("click", ()=>{
  const f = db.familias.find(x=>x.id===selectedId); if(!f) return;
  f.membros.push({id: crypto.randomUUID(), nome:"", parentesco:"", idade:"", nis:"", escolaridade:"", renda:""});
  touch(); render();
});

qs("#addTimeline").addEventListener("click", ()=>{
  const f = db.familias.find(x=>x.id===selectedId); if(!f) return;
  f.timeline.unshift({id: crypto.randomUUID(), tipo:"Acompanhamento", dataISO: new Date().toISOString(), titulo:"Registro", descricao:""});
  touch(); render();
});

qs("#addVisita").addEventListener("click", ()=>{
  const f = db.familias.find(x=>x.id===selectedId); if(!f) return;
  f.visitas.unshift({id: crypto.randomUUID(), dataISO: new Date().toISOString(), objetivo:"", observacoes:""});
  touch(); render();
});

qs("#exportCsv").addEventListener("click", ()=>{
  download(`prontuario_suas_${new Date().toISOString().slice(0,10)}.csv`, toCSV(db.familias), "text/csv;charset=utf-8");
});
qs("#exportJson").addEventListener("click", ()=>{
  download(`prontuario_suas_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(db,null,2), "application/json");
});
qs("#printBtn").addEventListener("click", ()=>window.print());

qs("#importJson").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      const familias = Array.isArray(data?.familias) ? data.familias : (Array.isArray(data) ? data : null);
      if(!familias) throw new Error();
      db = { familias };
      selectedId = null;
      saveDB(db); render();
    } catch { alert("Arquivo JSON inválido"); }
  };
  reader.readAsText(f);
});

// Configurações / Logo
const cfgModal = qs("#cfgModal");
qs("#cfgBtn").addEventListener("click", ()=>{
  qs("#cfgLogoPreview").src = loadLogo();
  cfgModal.showModal();
});
qs("#cfgLogoInput").addEventListener("change", (e)=>{
  const f=e.target.files && e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = () => { const b64 = String(reader.result); saveLogo(b64); qs("#cfgLogoPreview").src=b64; qs("#logo").src=b64; };
  reader.readAsDataURL(f);
});
qs("#cfgLogoReset").addEventListener("click", ()=>{
  saveLogo(PLACEHOLDER_LOGO);
  qs("#cfgLogoPreview").src = PLACEHOLDER_LOGO;
  qs("#logo").src = PLACEHOLDER_LOGO;
});

function openDetails(){
  setHidden(qs("#detailsEmpty"), true);
  setHidden(qs("#details"), false);
  render();
}

// ======= Inicialização =======
document.addEventListener("DOMContentLoaded", ()=>{
  // coloca logo carregada
  qs("#logo").src = loadLogo();
  render();
});
</script>
</body>
</html>
